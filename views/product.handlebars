<div class="row ml-5 mt-5">
  <div class="col-2">
    <div class="nav flex-column">
      <a class="navbar-brand mb-5" id="logo" href="/">E-commerce website</a>
      <div class="list-group">
        <a class="list-group-item list-group-item-action" href="/">首頁</a>
      </div>
      {{#each categories}}
      <div class="list-group">
        <a class="list-group-item list-group-item-action" href="/Category/{{this.id}}">{{this.name}}</a>
      </div>
      {{/each}}
    </div>
  </div>

  <div class="index col-3 ml-5 mt-5 mb-5">
    <a class="categoryName" style="text-decoration: none;"
      href="/Category/{{product.Product_category.id}}">{{product.Product_category.name}}
    </a>
    </br />
    <img class="mt-5" src="{{product.image}}" width="300px" height="400px" alt="image">
  </div>

  <div class="col-5 mt-5">
    <div class="card-body mt-5">
      <h2 class="card-title" style="text-align: center; color: gray;">{{product.name}}</h2>
      <h6 class="count mt-1" style="text-align: center; color: gray;">庫存數 {{product.count}}</h6>
      <h5 class="price mt-5" style="text-align: center; color: rgb(32, 80, 240);">定價 $ {{product.price}}</h5>

      <div class="star ml-5">
        <span class="stars d-flex mt-5 align-items-center ml-5">
          {{#star ratingAve}}{{/star}}
        </span>
      </div>
      {{#ifCond product.Comments.length 0}}
      <div class="help-block mt-4" style="text-align: center; color: rgb(112, 21, 231);">此商品尚未有人評價</div>
      {{else}}
      <div class="help-block mt-4" style="text-align: center; color: rgb(112, 21, 231);">平均 {{ratingAve}} 分，已有
        {{product.Comments.length}} 人評價
      </div>
      {{/ifCond}}

      <div class="cartBtn" style="text-align: center;">
        <form action="/cart" method="POST">
          <div class="selectQty mt-5">
            <input type="button" value='-' class='qtyMinus' field='quantity'>
            <input type='text' name='quantity' value='1' class='qty'>
            <input type='button' value="+" class='qtyPlus' field='quantity'>
          </div>
          {{#ifCond product.count 0}}
          <button type="submit" class="btn btn-success mt-4" disabled /><i class="fa fa-truck" aria-hidden="true"></i>
          商品補貨中</button>
          <span class="notice btn btn-primary mt-4"><i class="fa fa-envelope" aria-hidden="true"></i> 貨到通知我</span>
          {{else}}
          <input type="hidden" name="productId" value="{{product.id}}">
          <button type="submit" class="btn btn-success mt-4"><i class="fas fa-shopping-cart"></i> 加入購物車</button>
          <a href="/cart" class="btn btn-primary mt-4">前往購物車 ></a>
          {{/ifCond}}
        </form>

        <div class="modal">
          <div class="modal-content">
            <span class="close">&times;</span>
            <h5 class="mt-3" style="text-align: center; color: gray;">到貨通知</h5>

            <div class="mt-2" style="color: gray; font-size: 16px;">
              商品名稱：<p style="color: red; font-size: 16px;">
                【{{product.Product_category.name}}】{{product.name}}</p>
            </div>

            <p>---------------------------------------</p>

            <form action="" method="post">
              <div class="form-group row ml-5">
                <label style="color: gray; font-size: 16px;" for=" inputEmail">電子郵件：&nbsp;</label>
                <input style="font-size: 16px;" type="text" name="email" class="form" value="{{loginUser.email}}"
                  required autofocus>
              </div>
              <div class="form-group row ml-4">
                <label style="color: gray; font-size: 16px;" for=" inputEmail">確認電子郵件：&nbsp;</label>
                <input style="font-size: 16px;" type="text" name="email_confirm" class="form"
                  value="{{loginUser.email}}">
              </div>

              <p>---------------------------------------</p>
              <p style="color: red; font-size: 16px;">*此功能僅為貨到通知，無法保留商品喔。</p>

              <button class="btn btn-primary">送出</button>
            </form>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<hr class="ml-5 col-10">

<div class="ml-5 mt-5 mb-5">
  <h4>商品描述</h4>
  <br />

  <small>{{product.description}}</small>
</div>

<hr class="ml-5 col-10">

<div class="ml-5 mt-5 mb-5">
  <h4>相關商品</h4>
</div>

<div class="mt-5 ml-5 col-10">
  <div class="row">
    {{#each productsFilter}}
    <div class="col-md-3">
      <div class="card mb-4 shadow-sm">
        <a href="/product/{{this.id}}">
          <img class="card-img-top" src="{{this.image}}" alt="Card image cap" width="320px" height="180px">
        </a>
        <div class="card-body">
          <h6 class="card-text" style="text-align: center;">
            <a class="productName" style="text-decoration: none;" href="/product/{{this.id}}">
              {{this.name}}
            </a>
          </h6>
          <div class="badgeBox" style="text-align: center;">
            <span class="badge badge-primary">NT $ {{this.price}}</span>
          </div>
          <div class="cartBtn mt-2" style="text-align: center;">
            <form action="/cart" method="POST">
              <input type="hidden" name="productId" value="{{this.id}}">
              <button type="submit" class="btn btn-success mt-2">加入購物車</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {{/each}}
  </div>
</div>

<hr class="ml-5 col-10">

<div class="ml-5 mt-5 mb-5">
  <h4>買家評論 ({{product.Comments.length}}則評論)</h4>

  <div class="list-group mt-5 col-11">

    <div class="card">
      {{#each product.Comments}}
      <div class="card-header">
        <small>{{this.User.name}} －{{moment this.createdAt}}</small>
      </div>
      <div class="list-group-item  list-group-item-action">
        {{#ifCond this.User.id ../loginUser.id}}
        <form action="/product/{{Product.id}}/rate/{{this.id}}?_method=DELETE" method="POST" style="float: right;">
          <button type="submit" class="btn btn-danger">x</button>
        </form>
        {{/ifCond}}
        <span class="stars d-flex mb-3 mt-2">
          {{#star this.rating}}{{/star}}
        </span>
        <p>{{this.comment}}</p>
      </div>
      {{/each}}
    </div>
  </div>

  {{#each orders}}
  {{#ifCond this.User.id ../loginUser.id}}
  {{#each this.PaymentStatus}}
  {{#ifCond this.paymentStatus '已付款'}}
  <h4 class="mt-5 mb-5">留下您的評論：</h4>

  <form action="/product/{{../../product.id}}/rate" method="POST">
    <div class="form-group col-11">
      <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="請在此輸入內容" required></textarea>
    </div>

    <p class="mb-3 d-flex align-items-center">
      <span class="text-secondary ml-2">
        商品評分：
      </span>
      <span class="starrating risingstar d-flex justify-content-center flex-row-reverse">
        <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5分"></label>
        <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4分"></label>
        <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3分"></label>
        <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2分"></label>
        <input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1分"></label>
      </span>
    </p>


    <input type="hidden" name="ProductId" value="{{../../product.id}}" />
    <button type="submit" class="btn btn-primary ml-3 mt-2">送出評論</button>
  </form>
  {{/ifCond}}
  {{/each}}
  {{/ifCond}}
  {{/each}}
</div>

<br />
<div class="back ml-5 mb-5">
  <a class="ml-3" href="javascript:history.back()">回上一頁</a>
</div>

<script>

  const qtyMinus = document.querySelector('.qtyMinus')
  const qtyPlus = document.querySelector('.qtyPlus')
  const qty = document.querySelector('.qty')
  const modal = document.querySelector('.modal')
  const btn = document.querySelector('.notice')
  const span = document.querySelector('.close')

  qtyMinus.addEventListener('click', () => {
    if (qty.value > 1) return qty.value--
    return qty.value === 1
  })

  qtyPlus.addEventListener('click', () => {
    if (qty.value >= 10) return qty.value === 10
    return qty.value++
  })

  // When the user clicks the button, open the modal 
  btn.onclick = () => {
    modal.style.display = "block";
  }

  // When the user clicks on <span> (x), close the modal 
  span.onclick = () => {
    modal.style.display = "none";
  }

</script>